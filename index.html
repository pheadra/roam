<!DOCTYPE HTML>
<html lang="ko">
<head>
    <title>어흥이와의 채팅</title>
    <meta charset="utf-8">
    <script src="https://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
    <script src='./javascripts/moment.js'></script>
    <link rel="stylesheet" type="text/css" href="./stylesheets/example.css">
    <meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>

<!-- CHAT MARKUP -->
<div class="example-chat l-demo-container">
    <header>어흥이와의 채팅</header>

    <div class='example-chat-toolbar'>
        <label for="nameInput">Username:</label>
        <input type='text' id='nameInput' placeholder='enter a username...' value="어흥이">
    </div>

    <ul id='example-messages' class="example-chat-messages"></ul>

    <footer>
        <input type='text' id='messageInput'  placeholder='Type a message...'>
    </footer>
</div>

<!-- CHAT JAVACRIPT -->
<script>
    // CREATE A REFERENCE TO FIREBASE
    var unreadcount = 0;
    var messagesRef = new Firebase('https://haru.firebaseio.com');

    // REGISTER DOM ELEMENTS
    var messageField = $('#messageInput');
    var nameField = $('#nameInput');

    var messageList = $('#example-messages');



    var url = window.location.search;
    url = url.substring(1);
    var parseQueryString = function( queryString ) {
        var params = {}, queries, temp, i, l;

        // Split into key/value pairs
        queries = queryString.split("&");

        // Convert the array of strings into an object
        for ( i = 0, l = queries.length; i < l; i++ ) {
            temp = queries[i].split('=');
            params[temp[0]] = temp[1];
        }

        return params;
    };

    var param = parseQueryString(url);
    console.log(param);
    if(param.id != undefined){
        nameField.val(param.id);
    }


    // LISTEN FOR KEYPRESS EVENT
    messageField.keypress(function (e) {
        if (e.keyCode == 13) {
            //FIELD VALUES
            var username = nameField.val();
            var message = messageField.val();

            unreadcount = 0;
            document.title = '어흥이와의 채팅 ('+ unreadcount + ')';

            //SAVE DATA TO FIREBASE AND EMPTY FIELD
            messagesRef.push({name:username, text:message, date:moment().format('YYYY-MM-DD hh:mm:ss')});
            messageField.val('');
        }
    });

    // Add a callback that is triggered for each chat message.
    messagesRef.limitToLast(20).on('child_added', function (snapshot) {
        //GET DATA
        var data = snapshot.val();
        var username = data.name || param.id ||  "어흥이";
        var message = data.text;

        unreadcount++;
        document.title = '어흥이와의 채팅 ('+ unreadcount + ')';

        //CREATE ELEMENTS MESSAGE & SANITIZE TEXT
        var messageElement = $("<li>");
        var nameElement = $("<strong class='example-chat-username'></strong>")
        nameElement.text(username);


        if(data.date != undefined) {
            var time = moment(data.date, "YYYY-MM-DD HH:mm:ss"); //data.date;
            //console.log(time);
            messageElement.text(message + ' (' + time.format('MM-DD HH:mm:ss') + ')').prepend(nameElement);
        } else {
            messageElement.text(message).prepend(nameElement);

        }
        //ADD MESSAGE
        messageList.append(messageElement);

        //SCROLL TO BOTTOM OF MESSAGE LIST
        messageList[0].scrollTop = messageList[0].scrollHeight;
    });
</script>

</body>
</html>